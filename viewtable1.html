<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Table Viewer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
              /* Smooth scrolling for the entire page */
html {
  scroll-behavior: smooth;
}

/* Custom scrollbar for the entire page */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}

::-webkit-scrollbar-track {
  background: var(--bg-color);
  border-radius: 6px;
}

::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 6px;
  border: 3px solid var(--bg-color);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

::-webkit-scrollbar-corner {
  background: var(--bg-color);
}

/* Firefox scrollbar */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--bg-color);
}

/* Smooth scrolling for all containers with overflow */
.container, .exam-info-container, .table-container {
  scroll-behavior: smooth;
}

/* Header shadow on scroll */
header {
  transition: box-shadow 0.3s ease;
}

header.scrolled {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --accent: #4895ef;
      --light: #f8f9fa;
      --dark: #1a1a2e;
      --gray: #6c757d;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --bg-color: #f5f7fb;
      --text-color: #1a1a2e;
      --header-bg: linear-gradient(135deg, var(--primary), var(--accent));
      --card-bg: white;
      --sidebar-bg: white;
      --footer-bg: white;
      --container-bg: white;
      --table-header-bg: var(--primary);
      --table-row-even: #f9f9f9;
      --table-row-hover: #f1f1f1;
      --highlight-color: #fffacd;
    }

    .dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --header-bg: linear-gradient(135deg, #1a1a2e, #16213e);
      --card-bg: #1e1e1e;
      --sidebar-bg: #1e1e1e;
      --footer-bg: #1e1e1e;
      --container-bg: #1e1e1e;
      --table-header-bg: #2a2a2a;
      --table-row-even: #252525;
      --table-row-hover: #2e2e2e;
      --highlight-color: #3a3a00;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    header {
      background: var(--header-bg);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: background 0.3s ease;
      margin-bottom: 2rem;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .header-title i {
      font-size: 1.2rem;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .toggle-icon {
      font-size: 1rem;
      color: white;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .exam-info-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    .exam-info-item {
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 200px;
      flex: 1 1 200px;
    }

    .exam-info-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .exam-info-text {
      display: flex;
      flex-direction: column;
    }

    .exam-info-label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 2px;
    }

    .exam-info-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-color);
    }

    .file-info-item {
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 200px;
      flex: 1 1 200px;
    }

    .file-info-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: #f72585;
    }

    .file-info-text {
      display: flex;
      flex-direction: column;
    }

    .file-info-label {
      font-size: 13px;
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 2px;
    }

    .file-info-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-color);
      word-break: break-all;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: rgba(0,0,0,0.1);
      margin: 20px 0;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #tableContainer {
      margin: 30px 0;
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      max-height: calc(100vh - 250px);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      table-layout: auto;
    }

    th {
      background: var(--table-header-bg);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    tr:nth-child(even) {
      background: var(--table-row-even);
    }

    tr:hover {
      background: var(--table-row-hover);
    }

    .highlight {
      background: var(--highlight-color) !important;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin-top: 20px;
      transition: var(--transition);
    }

    .back-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 30px;
      color: var(--gray);
    }

    .loading i {
      animation: spin 1s linear infinite;
    }

    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }
    
    .progress-bar {
      height: 10px;
      border-radius: 8px;
      background-color: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }
    .action-buttons {
  display: flex;
  gap: 5px;
}

.action-btn {
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  border: none;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 4px;
}

.edit-btn {
  background-color: var(--warning);
  color: white;
}

.edit-btn:hover {
  background-color: #e07e00;
}

.save-btn {
  background-color: var(--success);
  color: white;
  display: none;
}

.save-btn:hover {
  background-color: #00a8d4;
}

.editable {
  background-color: var(--highlight-color);
  outline: 1px solid var(--warning);
}

.editable-input {
  width: 100%;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  color: var(--dark);
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: white;
  background-color: var(--primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  animation: slideIn 0.3s ease-out;
}

.toast-success {
  background-color: #4BB543;
}

.toast-error {
  background-color: var(--danger);
}

.toast-warning {
  background-color: var(--warning);
}

.fade-out {
  animation: fadeOut 0.5s ease-out forwards;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

    @media (max-width: 768px) {
      .exam-info-container {
        gap: 15px;
        padding: 15px;
      }
      
      .exam-info-item {
        min-width: 160px;
        flex: 1 1 160px;
      }
      
      th, td {
        padding: 10px 12px;
      }
    }

    @media (max-width: 480px) {
      .exam-info-container {
        flex-direction: column;
        gap: 12px;
      }
      
      .exam-info-item {
        width: 100%;
      }
      
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      
      .header-title {
        flex-direction: column;
        text-align: center;
      }
      
      .theme-toggle {
        margin-top: 0.5rem;
      }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
   .search-container {
  margin: 20px 0;
  display: flex;
  justify-content: center;
}

.search-box {
  position: relative;
  width: 100%;
  max-width: 500px;
  display: flex;
  align-items: center;
}

.search-box i {
  position: absolute;
  left: 12px;
  color: var(--gray);
  z-index: 1;
}

.search-box input {
  width: 100%;
    padding: 10px 40px 10px 40px; /* Extra right padding for clear button */

  border-radius: 8px;
  border: 1px solid rgba(0,0,0,0.1);
  background: var(--card-bg);
  color: var(--text-color);
  font-size: 14px;
  transition: var(--transition);
  box-shadow: var(--card-shadow);
}
.clear-btn {
  position: absolute;
  right: 10px;
  background: none;
  border: none;
  color: var(--gray);
  cursor: pointer;
  padding: 5px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  opacity: 0;
  visibility: hidden;
  transform: scale(0.8);
  z-index: 2;
}

.clear-btn.visible {
  opacity: 1;
  visibility: visible;
  transform: scale(1);
}

.clear-btn:hover {
  background-color: rgba(0,0,0,0.1);
  color: var(--danger);
}

.clear-btn i {
  font-size: 12px;
  transition: var(--transition);
}
.search-highlight {
  background-color: var(--highlight-color);
  font-weight: 600;
  padding: 2px;
  border-radius: 3px;
}

.no-results {
  text-align: center;
  padding: 20px;
  color: var(--danger);
  font-weight: 500;
  display: none;
}
.home-btn-container {
  display: flex;
  justify-content: flex-end;
  padding: 10px 20px; /* optional spacing */
}

  .home-btn {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            text-decoration: none;
            
        }

        .home-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
  </style>
</head>
<body>
  <header>
    <div class="header-title">
      <h1 id="tableTitle">Exam Upload Table Viewer</h1>
    </div>
    <div class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon toggle-icon"></i>
      <label class="toggle-switch">
        <input type="checkbox" id="darkModeToggle">
        <span class="slider"></span>
      </label>
      <i class="fas fa-sun toggle-icon"></i>
    </div>
  </header>
<div class="search-container">
  <div class="search-box">
    <i class="fas fa-search"></i>
    <input type="text" id="tableSearch" placeholder="Search in table...">
    <button id="clearSearch" class="clear-btn" title="Clear search">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="home-btn-container">
  <a href="index.html" class="home-btn">
    <i class="fas fa-home"></i> Home
  </a>
</div>

</div>
  <div class="container">
    <div id="examInfo"></div>

    <div id="tableContainer">
      <div class="loading">
        <i class="fas fa-spinner"></i>
        <span>Loading table data...</span>
      </div>
    </div>
    
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <a href="upload1.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Back to Upload
    </a>
  </div>

  <script>
    let tableData = []; // Store table data globally

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      applyTheme();
      displayExamInfo();
      loadTableData();
      
      // Set up dark mode toggle
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
          } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
          }
        });
      }
    });

    // Apply theme based on user preference
    function applyTheme() {
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      let currentTheme = localStorage.getItem('theme');
      
      // Use system preference if no theme is set
      if (!currentTheme) {
        currentTheme = prefersDarkScheme.matches ? 'dark' : 'light';
        localStorage.setItem('theme', currentTheme);
      }
      
      // Apply the stored theme
      if (currentTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').checked = true;
      }
    }

    // Display exam information
    function displayExamInfo() {
      const examData = JSON.parse(sessionStorage.getItem('selectedExam'));
      const tableName = sessionStorage.getItem('selectedTable');

      if (examData) {
        const examInfoDiv = document.getElementById('examInfo');
        examInfoDiv.innerHTML = `
          <div class="exam-info-container">
            <div class="exam-info-item">
              <div class="exam-info-icon" style="background-color: #4361ee;">
                <i class="fas fa-file-signature"></i>
              </div>
              <div class="exam-info-text">
                <div class="exam-info-label">Exam Name</div>
                <div class='exam-info-value'>${examData.exam_name || 'N/A'}</div>
              </div>
            </div>
            
            <div class="exam-info-item">
              <div class="exam-info-icon" style="background-color: #4cc9f0;">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="exam-info-text">
                <div class="exam-info-label">Start Date</div>
                <div class="exam-info-value">${examData.start_date ? new Date(examData.start_date).toLocaleDateString() : 'N/A'}</div>
              </div>
            </div>
            
            <div class="exam-info-item">
              <div class="exam-info-icon" style="background-color: #f8961e;">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="exam-info-text">
                <div class="exam-info-label">End Date</div>
                <div class="exam-info-value">${examData.end_date ? new Date(examData.end_date).toLocaleDateString() : 'N/A'}</div>
              </div>
            </div>
            
            <div class="exam-info-item">
              <div class="exam-info-icon" style="background-color: #3a0ca3;">
                <i class="fas fa-building"></i>
              </div>
              <div class="exam-info-text">
                <div class="exam-info-label">Department</div>
                <div class="exam-info-value">${examData.department_name || 'N/A'}</div>
              </div>
            </div>
            
            <div class="exam-info-item">
              <div class="exam-info-icon" style="background-color: #7209b7;">
                <i class="fas fa-cube"></i>
              </div>
              <div class="exam-info-text">
                <div class="exam-info-label">Block</div>
                <div class="exam-info-value">${examData.block_number || 'N/A'}</div>
              </div>
            </div>
            
            ${tableName ? `
              <div class="exam-info-item">
                <div class="exam-info-icon" style="background-color: #f72585;">
                  <i class="fas fa-table"></i>
                </div>
                <div class="exam-info-text">
                  <div class="exam-info-label">Table</div>
                  <div class="exam-info-value">${tableName.replace(/_/g, ' ')}</div>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
    }
    
    // Load table data for exam upload tables
    async function loadTableData() {
      try {
        console.log('Starting to load exam table data...');
        
        // Get table name from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const tableName = urlParams.get('table');
        
        if (!tableName) {
          throw new Error('No table selected - missing table parameter in URL');
        }
        
        console.log('Exam table name from URL:', tableName);
        // Store the table name in sessionStorage
        sessionStorage.setItem('selectedTable', tableName);

        // Set title
        document.getElementById('tableTitle').textContent = `ðŸ“Š ${tableName.replace(/_/g, ' ')}`;
        document.title = `ðŸ“Š ${tableName.replace(/_/g, ' ')} | Exam Table Viewer`;

        // Show loading state
        const tableContainer = document.getElementById('tableContainer');
        tableContainer.innerHTML = `
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <span>Loading exam table data...</span>
          </div>
        `;

        // Show progress bar
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        progressContainer.style.display = 'block';
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 5;
          progressBar.style.width = `${Math.min(progress, 90)}%`;
          if (progress >= 90) clearInterval(progressInterval);
        }, 200);

        // Check if electronAPI is available
        if (!window.electronAPI || !window.electronAPI.getExamUploadTableData) {
          throw new Error('Electron API is not properly initialized - getExamUploadTableData function missing');
        }

        console.log('Fetching exam table data from electron API...');
        tableData = await window.electronAPI.getExamUploadTableData(tableName);
        console.log('Received exam table data:', tableData ? `Array of ${tableData.length} items` : 'null');

        if (!tableData || tableData.length === 0) {
          console.warn('No data found in exam table');
          tableContainer.innerHTML = '<div class="loading"><i class="fas fa-database"></i><span>No data found in this exam table.</span></div>';
          progressContainer.style.display = 'none';
          return;
        }

        // Complete progress bar
        progressBar.style.width = '100%';
        setTimeout(() => progressContainer.style.display = 'none', 500);

        // Get headers from first row
        const headers = Object.keys(tableData[0]);
        console.log('Exam table headers:', headers);
        
        // Create table HTML without checkbox column
        let html = '<table><thead><tr>';
        headers.forEach(h => {
          html += `<th>${formatHeader(h)}</th>`;
        });
        html += '<th>Action</th>';
        html += '</tr></thead><tbody>';

        // Add rows without checkboxes
        tableData.forEach((row, index) => {
          const rowId = row.id || index;
          html += '<tr>';
          
          headers.forEach(h => {
            const cell = row[h] !== null && row[h] !== undefined ? row[h] : '-';
            html += `<td data-column="${h}" data-original="${escapeHtml(cell)}">${cell}</td>`;
          });
          
          // Add action buttons (only edit/save, no delete)
          html += `
            <td class="action-buttons">
              <button class="action-btn edit-btn" data-row-id="${rowId}">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="action-btn save-btn" data-row-id="${rowId}" style="display: none;">
                <i class="fas fa-save"></i> Save
              </button>
            </td>
          `;
          
          html += '</tr>';
        });

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
        setupExamActionButtons(tableName);
        
        console.log('Exam table successfully loaded and rendered');
        
      } catch (err) {
        console.error('Error loading exam table data:', err);
        const errorMessage = err.message || 'Unknown error occurred';
        
        document.getElementById('tableContainer').innerHTML = `
          <div class="loading" style="color: var(--danger)">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Error loading exam table data: ${errorMessage}</span>
          </div>`;
          
        document.getElementById('progressContainer').style.display = 'none';
        
        // Show additional debug info if available
        if (err.stack) {
          console.error('Error stack:', err.stack);
        }
      }
    }

    // Format table headers
    function formatHeader(header) {
      return header.replace(/[_]+/g, ' ').replace(/\b\w/g, l => l.toUpperCase()).trim();
    }
    
    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    // Function to set up edit/save button handlers for exam tables
    function setupExamActionButtons(tableName) {
      // Edit button functionality
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const rowId = this.getAttribute('data-row-id');
          const row = this.closest('tr');
          
          // Hide edit button, show save button
          this.style.display = 'none';
          row.querySelector('.save-btn').style.display = 'flex';
          
          // Make all cells editable except action cells
          const cells = row.querySelectorAll('td:not(.action-buttons)');
          cells.forEach(cell => {
            const originalValue = cell.getAttribute('data-original');
            cell.classList.add('editable');
            cell.innerHTML = `<input type="text" class="editable-input" value="${escapeHtml(originalValue)}">`;
          });
        });
      });
      
      // Save button functionality
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const rowId = this.getAttribute('data-row-id');
          const row = this.closest('tr');
          const tableName = sessionStorage.getItem('selectedTable');
          
          // Show loading state
          const originalText = this.innerHTML;
          this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
          this.disabled = true;

          try {
            // Collect updated data
            const updatedData = {};
            const cells = row.querySelectorAll('td:not(.action-buttons)');
            
            cells.forEach(cell => {
              const columnName = cell.getAttribute('data-column');
              const input = cell.querySelector('.editable-input');
              const newValue = input ? input.value : cell.textContent;
              updatedData[columnName] = newValue;
            });

            // Get primary key column name
            const tableInfo = await window.electronAPI.getExamUploadTableInfo(tableName);
            const pkColumn = tableInfo.primaryKey;

            // Call IPC to update row in exam table
            const result = await window.electronAPI.examUpdateUploadRow({
              tableName,
              pkColumn,
              rowId,
              updatedData
            });

            if (!result.success) {
              throw new Error(result.error || 'Exam table update failed');
            }

            // Update UI on success
            cells.forEach(cell => {
              const columnName = cell.getAttribute('data-column');
              const newValue = updatedData[columnName];
              cell.classList.remove('editable');
              cell.innerHTML = newValue;
              cell.setAttribute('data-original', newValue);
            });

            // Toggle buttons
            this.style.display = 'none';
            row.querySelector('.edit-btn').style.display = 'flex';
            
            showToast(result.message || 'Exam row updated successfully!', 'success');
          } catch (err) {
            console.error('Exam update error:', err);
            
            // Revert UI changes
            const cells = row.querySelectorAll('td:not(.action-buttons)');
            cells.forEach(cell => {
              const originalValue = cell.getAttribute('data-original');
              cell.classList.remove('editable');
              cell.innerHTML = originalValue;
            });

            showToast(err.message.includes('no such table') 
              ? `Exam table "${tableName}" not found` 
              : err.message, 
            'error');
          } finally {
            // Restore button
            this.innerHTML = originalText;
            this.disabled = false;
          }
        });
      });
    }

    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('tableSearch');
      const clearBtn = document.getElementById('clearSearch');
      
      if (searchInput && clearBtn) {
        // Initialize with clear button hidden
        clearBtn.classList.remove('visible');
        
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.trim();
          
          // Toggle clear button visibility
          if (searchTerm) {
            clearBtn.classList.add('visible');
          } else {
            clearBtn.classList.remove('visible');
          }
          
          if (searchTerm) {
            highlightSearchResults(searchTerm.toLowerCase());
          } else {
            clearSearchHighlights();
          }
        });
        
        clearBtn.addEventListener('click', function() {
          searchInput.value = '';
          searchInput.focus();
          this.classList.remove('visible');
          clearSearchHighlights();
        });
      }
    });

    function highlightSearchResults(searchTerm) {
      let hasResults = false;
      let firstMatch = null;
      const rows = document.querySelectorAll('#tableContainer tbody tr');
      
      // Create or get no results element
      let noResults = document.querySelector('.no-results');
      if (!noResults) {
        noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'No matching results found';
        document.getElementById('tableContainer').appendChild(noResults);
      }
      
      rows.forEach(row => {
        let rowMatch = false;
        const cells = row.querySelectorAll('td:not(.action-buttons)');
        
        cells.forEach(cell => {
          const cellText = cell.textContent.toLowerCase();
          const originalContent = cell.getAttribute('data-original') || cell.textContent;
          
          if (cellText.includes(searchTerm)) {
            rowMatch = true;
            const highlightedContent = originalContent.replace(
              new RegExp(searchTerm, 'gi'),
              match => `<span class="search-highlight">${match}</span>`
            );
            cell.innerHTML = highlightedContent;
          } else {
            cell.innerHTML = originalContent;
          }
        });
        
        if (rowMatch) {
          hasResults = true;
          row.style.display = '';
          // Store the first matching row for scrolling
          if (!firstMatch) {
            firstMatch = row;
          }
        } else {
          row.style.display = 'none';
        }
      });
      
      // Show/hide no results message
      noResults.style.display = hasResults ? 'none' : 'block';
      
      // Scroll to the first matching row if found
      if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function clearSearchHighlights() {
      const rows = document.querySelectorAll('#tableContainer tbody tr');
      const noResults = document.querySelector('.no-results');
      
      if (noResults) {
        noResults.style.display = 'none';
      }
      
      rows.forEach(row => {
        row.style.display = '';
        const cells = row.querySelectorAll('td:not(.action-buttons)');
        
        cells.forEach(cell => {
          const originalContent = cell.getAttribute('data-original') || cell.textContent;
          cell.innerHTML = originalContent;
        });
      });
    }
  </script>
</body>
</html>